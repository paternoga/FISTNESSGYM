@page "/store/cart"
@inject ICartService CartService
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@using System.Security.Claims
@using FISTNESSGYM.Models.database
@using FISTNESSGYM.Services

<PageTitle>KOSZYK</PageTitle>

<h3>Koszyk</h3>

@if (cartItems == null)
{
    <p>Ładowanie koszyka...</p>
}
else if (!cartItems.Any())
{
    <p>Twój koszyk jest pusty.</p>
}
else
{
    <div>
        <ul>
            @foreach (var item in cartItems)
            {
                <li>
                    @item.Product.Name - @item.Quantity sztuk - @item.Product.Price zł
                    <button @onclick="() => RemoveFromCart(item.Product.Id)">Usuń</button>
                    <button @onclick="PlaceOrder">Złóż zamówienie</button>
                </li>
            }
        </ul>
        <p>Łączna kwota: @totalAmount zł</p>
        <button @onclick="ClearCart">Wyczyść koszyk</button>
    </div>
}

@code {
    private List<CartItem> cartItems = new();
    private decimal totalAmount;

    protected override async Task OnInitializedAsync()
    {
        await LoadCartItems();
    }

    private async Task LoadCartItems()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity.IsAuthenticated)
        {
            var userId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            if (!string.IsNullOrEmpty(userId))
            {
                cartItems = await CartService.GetCartItemsAsync(userId);
                totalAmount = CalculateTotalAmount(cartItems);
            }
        }
        else
        {
            cartItems.Clear();
            totalAmount = 0;
        }

        StateHasChanged();
    }

    private decimal CalculateTotalAmount(List<CartItem> items)
    {
        decimal total = 0;
        foreach (var item in items)
        {
            total += item.Quantity * item.Product.Price;
        }
        return total;
    }

    private async Task RemoveFromCart(int productId)
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity.IsAuthenticated)
        {
            var userId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            if (!string.IsNullOrEmpty(userId))
            {
                await CartService.RemoveFromCartAsync(userId, productId);
                await LoadCartItems(); 
            }
        }
    }

    private async Task ClearCart()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity.IsAuthenticated)
        {
            var userId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            if (!string.IsNullOrEmpty(userId))
            {
                await CartService.ClearCartAsync(userId);
                await LoadCartItems(); 
            }
        }
    }
    private async Task PlaceOrder()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity.IsAuthenticated)
        {
            var userId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            if (!string.IsNullOrEmpty(userId))
            {
                decimal totalAmount = CalculateTotalAmount(cartItems);
                var order = new Order
                    {
                        UserId = userId,
                        OrderDate = DateTime.Now,
                        TotalAmount = totalAmount,
                        OrderStatusId = 1,
                        OrderStatusName = "Złożone"
                    };

                try
                {
                    await CartService.PlaceOrderAsync(order, cartItems);

                    await CartService.ClearCartAsync(userId);
                    await LoadCartItems();
                    NavigationManager.NavigateTo("/store/order-success");
                }
                catch (InvalidOperationException ex)
                {
                    await CartService.ClearCartAsync(userId);
                    NavigationManager.NavigateTo("/store/order-failed");
                }
            }
        }
    }


}

